# Loading packages

library(plotly)
library(ggplot2)
library(cowplot)
library(rgdal)

library(gridExtra)
library(htmlwidgets)
library(data.table)

library(httr)
library(ggtext)
library(tidyverse)
library(extrafont)
library(janitor)
library(ggpubr)
library(glue)

library(fdapace)
library(EpiEstim)
library(BMS)

# Reading and cleaning data

set.seed(04152021)
options(stringsAsFactors = F)
Data.districts = read.csv(url("https://api.covid19india.org/csv/latest/districts.csv"))
Data.states = read.csv(url("https://api.covid19india.org/csv/latest/states.csv"))

Districts = c(sort(unique(Data.districts$District[Data.districts$State ==
                                                    "Odisha"]))[-c(26, 30)], "All Districts")

Start.Date = "2020-05-01"
End.Date = "2021-04-15"

Lockdown.Dates = c(
  "2020-05-04",
  "2020-05-18",
  "2020-06-01",
  "2020-07-01",
  "2020-08-01",
  "2020-09-01",
  "2020-10-01",
  "2020-11-01",
  "2020-12-01",
  "2021-01-01",
  "2021-02-01",
  "2021-03-01",
  "2021-04-01"
)

Lockdown.Labels = data.frame(
  Date = Lockdown.Dates,
  Labels = c(
    "Lockdown 3.0",
    "Lockdown 4.0",
    "Unlock 1.0",
    "Unlock 2.0",
    "Unlock 3.0",
    "Unlock 4.0",
    "Unlock 5.0",
    "Unlock 6.0",
    "Unlock 7.0",
    "Unlock 8.0",
    "Unlock 9.0",
    "Unlock 10.0",
    "Unlock 11.0"
  )
)

Lockdown.Labels = Lockdown.Labels[as.numeric(as.Date(Lockdown.Labels$Date)) < as.numeric(as.Date(End.Date)), ]

# Figure 3

## Panels 3A and 3B

R.Curve = Incid.Data = list()

for (i in 1:length(Districts))
{
  District = Districts[i]
  
  if (District == "All Districts")
  {
    DistrictCum.Table = Data.states[Data.states$State == "Odisha", c("Date", "Confirmed")]
    DistrictInc.Table = data.frame(
      Date = DistrictCum.Table$Date,
      Incidence = c(
        DistrictCum.Table$Confirmed[1],
        diff(DistrictCum.Table$Confirmed)
      )
    )
  }
  
  else
  {
    DistrictCum.Table = Data.districts[Data.districts$State == "Odisha" &
                                         Data.districts$District == District, c("Date", "Confirmed")]
    DistrictInc.Table = data.frame(
      Date = DistrictCum.Table$Date,
      Incidence = c(
        DistrictCum.Table$Confirmed[1],
        diff(DistrictCum.Table$Confirmed)
      )
    )
  }
  
  rownames(DistrictInc.Table) = 1:nrow(DistrictInc.Table)
  colnames(DistrictInc.Table) = c("Date", "Incidence")
  
  DistrictInc.Table$Incidence = pmax(0, DistrictInc.Table$Incidence)
  DistrictInc.Table$Date = as.Date(DistrictInc.Table$Date)
  
  Length = nrow(DistrictInc.Table)
  
  R_Summary = estimate_R(
    DistrictInc.Table$Incidence,
    method = "parametric_si",
    config = list(
      t_start = 2:(Length - 4),
      t_end = 5:(Length - 1),
      n1 = 500,
      mean_si = 3.96,
      std_si = 4.75,
      n2 = 100,
      seed = 1,
      mcmc_control = list(
        init.pars = NULL,
        burnin = 10000,
        thin = 1000,
        seed = 1
      )
    )
  )
  
  mean.R <- R_Summary$R$`Mean(R)`
  std.R <- R_Summary$R$`Std(R)`
  
  lowerCI.R <- R_Summary$R$`Quantile.0.025(R)`
  upperCI.R <- R_Summary$R$`Quantile.0.975(R)`
  
  date.R <- as.Date(DistrictInc.Table$Date[5:(Length - 1)])
  
  R.summary <-
    data.frame(date.R, mean.R, std.R, lowerCI.R, upperCI.R)
  
  R.summary = R.summary[as.numeric(as.Date(R.summary$date.R)) <= as.numeric(as.Date(End.Date)), ]
  
  R.Curve[[i]] = R.summary
  
  incid.dates.R = DistrictInc.Table$Date
  incid.R = DistrictInc.Table$Incidence
  cumsum.R = cumsum(incid.R)
  
  incid = data.frame(incid.dates.R, incid.R, cumsum.R)
  
  incid = incid[as.numeric(as.Date(incid$incid.dates.R)) <= as.numeric(as.Date(End.Date)), ]
  
  Incid.Data[[i]] = incid
}

names(R.Curve) = names(Incid.Data) = Districts

### Panel 3A

R.Summary <- R.Curve$`All Districts`

R.Summary = R.Summary[as.numeric(as.Date(R.Summary$date.R)) >= as.numeric(as.Date(Start.Date)), ]

Labels.Height.3A = 3.6

Figure.3A <-
  ggplot(data = R.Summary, aes(x = date.R, y = mean.R)) + geom_point() + geom_line() + ylim(0, Labels.Height.3A *
                                                                                              10 / 9) +
  geom_ribbon(aes(ymin = lowerCI.R, ymax = upperCI.R),
              linetype = 2,
              alpha = 0.1) + xlab("Date") + ylab("Reproduction Number") + ggtitle("(A)") +
  scale_x_date(date_labels = "%d %b", date_breaks  = "7 days") + geom_hline(yintercept = 1,
                                                                            linetype = "dashed",
                                                                            color = "#138808") + geom_hline(yintercept = 2,
                                                                                                            linetype = "dashed",
                                                                                                            color = "#eb4034") +
  theme_classic() +
  theme(
    text               = element_text(family = "Helvetica Neue", face = "bold"),
    plot.title         = ggtext::element_markdown(size = 15),
    plot.subtitle      = element_text(size = 14, color = "#36454f"),
    plot.caption       = ggtext::element_markdown(
      hjust = 0,
      size = 15,
      lineheight = 1.1,
      face = "bold"
    ),
    axis.text          = element_text(size = 10, color = "#36454f"),
    axis.title         = element_text(size = 12),
    legend.position    = "none",
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(angle = 90)
  ) +
  geom_vline(
    mapping = aes(xintercept = as.Date(Date)),
    data = Lockdown.Labels,
    show.legend = FALSE
  ) +
  geom_label(
    data = Lockdown.Labels,
    mapping = aes(x = as.Date(Date),
                  y = Labels.Height.3A,
                  label = Labels),
    fontface = "bold"
  )

### Panel 3B

Incid.Summary = Incid.Data$`All Districts`

Incid.Summary = Incid.Summary[as.numeric(as.Date(Incid.Summary$incid.dates.R)) >= as.numeric(as.Date(Start.Date)), ]

Labels.Height.3B = 2100

Figure.3B = ggplot(Incid.Summary, aes(x = incid.dates.R, y = incid.R)) + geom_col() + xlab("Date") + ylab("Incidence of Confirmed Cases") +
  scale_x_date(date_labels = "%d %b", date_breaks  = "7 days") + ggtitle("(B)") +
  theme_classic() +
  theme(
    text               = element_text(family = "Helvetica Neue", face = "bold"),
    plot.title         = ggtext::element_markdown(size = 15),
    plot.subtitle      = element_text(size = 14, color = "#36454f"),
    plot.caption       = ggtext::element_markdown(
      hjust = 0,
      size = 15,
      lineheight = 1.1,
      face = "bold"
    ),
    axis.text          = element_text(size = 10, color = "#36454f"),
    axis.title         = element_text(size = 12),
    legend.position    = "none",
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(angle = 90)
  ) +
  geom_vline(
    mapping = aes(xintercept = as.Date(Date)),
    data = Lockdown.Labels,
    show.legend = FALSE
  ) +
  geom_label(
    data = Lockdown.Labels,
    mapping = aes(x = as.Date(Date),
                  y = Labels.Height.3B,
                  label = Labels),
    fontface = "bold"
  )

## Panels 3C and 3D

R.Curves.All = rbindlist(R.Curve, idcol = TRUE)
colnames(R.Curves.All)[1] = "District"

R.Curves.All = R.Curves.All[as.numeric(as.Date(R.Curves.All$date.R)) >= as.numeric(as.Date(Start.Date)), ]

### Panel 3C

heatmap_colors <- c(
  "alarm" = "red",
  "eh"    = "darkred",
  "eh1"    = "red4",
  "eh2"    = "red3",
  "eh3"    = "red2",
  "eh4"    = "red1",
  "good"  = "#138808",
  "none" = "white"
)

Decision = function(x)
{
  if (x >= 2)
  {
    return("alarm")
  }
  if (x >= 1.8 & x < 2)
  {
    return("eh")
  }
  if (x >= 1.6 & x < 1.8)
  {
    return("eh1")
  }
  if (x >= 1.4 & x < 1.6)
  {
    return("eh2")
  }
  if (x >= 1.2 & x < 1.4)
  {
    return("eh3")
  }
  if (x >= 1 & x < 1.2)
  {
    return("eh4")
  }
  if (x < 1)
  {
    return("good")
  }
}

danger <- 2
safe   <- 1

title    <- "(C)"
subtitle <- NULL
x_lab    <- "Date"
y_lab    <- "District"
caption  <- glue("**Note:**<br>",
                 " - Colored red if estimate is above 1 and green if below 1.<br>")

Labels.Height.3C = 33

R.Curves.All$heatmap = unlist(lapply(R.Curves.All$mean.R, Decision))
R.Curves.All$labels = rep(NA, nrow(R.Curves.All))

Lockdown.Labels.3C = data.frame(
  rep("", nrow(Lockdown.Labels)),
  as.Date(Lockdown.Labels$Date),
  rep(NA, nrow(Lockdown.Labels)),
  rep(NA, nrow(Lockdown.Labels)),
  rep(NA, nrow(Lockdown.Labels)),
  rep(NA, nrow(Lockdown.Labels)),
  rep("none", nrow(Lockdown.Labels)),
  Lockdown.Labels$Labels
)
colnames(Lockdown.Labels.3C) = colnames(R.Curves.All)

R.Curves.All = rbind(Lockdown.Labels.3C, R.Curves.All)

Figure.3C = ggplot(data = R.Curves.All,
                   mapping = aes(
                     x = date.R,
                     y = fct_relevel(fct_rev(District), "All Districts"),
                     fill = heatmap
                   )) + geom_tile() + scale_fill_manual(values = heatmap_colors) + expand_limits(y = 36) +
  labs(
    title    = title,
    subtitle = subtitle,
    x        = x_lab,
    y        = y_lab,
    caption  = caption
  ) +
  theme_minimal() +
  theme(
    text               = element_text(family = "Helvetica Neue", face = "bold"),
    plot.title         = ggtext::element_markdown(size = 15),
    plot.subtitle      = element_text(size = 14, color = "#36454f"),
    plot.caption       = ggtext::element_markdown(
      hjust = 0,
      size = 15,
      lineheight = 1.1,
      face = "bold"
    ),
    axis.text          = element_text(size = 10, color = "#36454f"),
    axis.title         = element_text(size = 12),
    legend.position    = "none",
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(angle = 90)
  ) +
  scale_x_date(date_labels = "%d %b", date_breaks  = "7 days") +
  geom_vline(
    mapping = aes(xintercept = as.Date(Date)),
    data = Lockdown.Labels,
    show.legend = FALSE
  ) +
  geom_label(
    mapping = aes(
      x = as.Date(date.R),
      y = Labels.Height.3C,
      label = labels
    ),
    fontface = "bold"
  )

### Panel 3D

Incid.All = rbindlist(Incid.Data, idcol = TRUE)
colnames(Incid.All)[1] = "District"

Last.Date = Incid.All[as.numeric(as.Date(Incid.All$incid.dates.R)) == as.numeric(as.Date(End.Date)), ]
Last.Fortnight = R.Curves.All[as.numeric(as.Date(R.Curves.All$date.R)) >= as.numeric(as.Date(End.Date)) - 13, ]
Last.Fortnight = Last.Fortnight[, -2] %>% group_by(District) %>% summarise_all(list(mean))

Last.Date = Last.Date[order(Last.Date$District), ]
Last.Fortnight = Last.Fortnight[order(Last.Fortnight$District), ]

test_data <- structure(
  list(
    name = Last.Fortnight$District,
    
    Rvalue = Last.Fortnight$mean.R,
    upper = Last.Fortnight$upperCI.R,
    lower = Last.Fortnight$lowerCI.R,
    cases = Last.Date$cumsum.R
  ),
  
  class = c("tbl_df", "tbl", "data.frame"),
  row.names = c(NA,-nrow(Last.Date))
)

fplot_colors <- heatmap_colors

fplot_shapes <- c("India" = 18,
                  "Not_India" = 16)

fplot_sizes <- c("India" = 1.35,
                 "Not_India" = 0.72)

title    <-
  "(D)"
subtitle <- NULL
x_lab    <- "District"
y_lab    <- "Instantaneous R"
caption  <- glue(
  "**Note:**<br>",
  " - Numbers in the left column indicate total cases by district on the date mentioned.<br>",
  " - Estimates and 95% confidence intervals are provided in each plot by district.<br>",
  " - Colored red if estimate is above 1 and green if below 1."
)

Figure.3D = test_data %>%
  mutate(
    fplot = unlist(lapply(Rvalue, Decision)),
    shape = ifelse(name == "All Districts", "India", "Not_India"),
    size  = shape
  ) %>%
  ggplot(aes(x = fct_relevel(reorder(name, Rvalue), "All Districts"), y = Rvalue)) +
  geom_hline(yintercept = safe,
             color = "gray40",
             linetype = 2) +
  geom_hline(yintercept = danger,
             color = "gray40",
             linetype = 2) +
  geom_pointrange(aes(
    ymin = lower,
    ymax = upper,
    color = fplot,
    shape = shape,
    size = size
  )) +
  scale_color_manual(values = fplot_colors) + scale_shape_manual(values = fplot_shapes) + scale_size_manual(values = fplot_sizes) +
  labs(
    title    = title,
    subtitle = subtitle,
    x        = x_lab,
    y        = y_lab,
    caption  = caption
  ) +
  coord_flip(ylim = c(NA, ceiling(max(
    Last.Fortnight$upperCI.R
  )))) +
  theme_minimal() +
  theme(
    text               = element_text(family = "Helvetica Neue", face = "bold"),
    plot.title         = ggtext::element_markdown(size = 15),
    plot.subtitle      = element_text(size = 14, color = "#36454f"),
    plot.caption       = ggtext::element_markdown(
      hjust = 0,
      size = 15,
      lineheight = 1.1,
      face = "bold"
    ),
    axis.text          = element_text(size = 10, color = "#36454f"),
    axis.title         = element_text(size = 12),
    legend.position    = "none",
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank()
  ) +
  geom_text(mapping = aes(label = cases, y = -0.45))

## Saving Figure 3

cairo_pdf("Figure 3.pdf",
          onefile = TRUE,
          height = 16.2,
          width = 27.0)

do.call("grid.arrange", c(list(
  Figure.3A, Figure.3B, Figure.3C, Figure.3D
), nrow = 2))

dev.off()

png(
  filename = "Figure 3.png",
  height = 16.2,
  width = 27.0,
  units = "in",
  type = "cairo",
  res = 144
)

do.call("grid.arrange", c(list(
  Figure.3A, Figure.3B, Figure.3C, Figure.3D
), nrow = 2))

dev.off()

# Figure 4

## Panels 4A-4F

percent.rank <- function(x, or)
{
  uni = sort(x, decreasing = ifelse(or ==  0, FALSE, TRUE))
  r = sapply(x, function(x) {
    which(uni == x)[1]
  })
  return((r - 1) / (length(x) - 1))
}

Theme.Vuls = read.csv("Vulnerability.csv")

Vuls.List = list()

Vuls.List[[1]] = Theme.Vuls[, c(1, 2:5)]
colnames(Vuls.List[[1]])[-1] = c("Population",
                                 "Literacy Rate",
                                 "Work Participation",
                                 "Per Capita NDDP")

Vuls.List[[2]] = Theme.Vuls[, c(1, 6:8)]
colnames(Vuls.List[[2]])[-1] = c(
  "Households with Improved Drinking",
  "Households Using Improved Sanitation ",
  "Households Using Clean Fuel"
)

Vuls.List[[3]] = Theme.Vuls[, c(1, 9:11)]
colnames(Vuls.List[[3]])[-1] = c("Public Hospitals",
                                 "Sub-divisional Hospitals",
                                 "General No. of Beds")

Vuls.List[[4]] = Theme.Vuls[, c(1, 12:16)]
colnames(Vuls.List[[4]])[-1] = c(
  "Total Beds Capacity",
  "Total ICU Beds Capacity",
  "Temporary Medical Camps Rural",
  "Temporary Medical Camps Urban",
  "COVID Hospital Test Centers"
)

Vuls.List[[5]] = Theme.Vuls[, c(1, 17:26)]
colnames(Vuls.List[[5]])[-1] = c(
  "HIV",
  "P Vivax",
  "P Falciparum",
  "Pneumonia",
  "TB",
  "Hypertension",
  "Cervical Cancer",
  "Breast Cancer",
  "Oral Cancer",
  "Obesity"
)

Vuls.List[[6]] = Theme.Vuls[, c(1, 27:31)]
colnames(Vuls.List[[6]])[-1] = c(
  "Socioeconomic and Demographic Factors",
  "Housing and Hygiene Conditions",
  "Availability of Health Care",
  "COVID Preparedness",
  "Epidemiological Factors"
)

names(Vuls.List) = c(
  "Socioeconomic and Demographic Factors",
  "Housing and Hygiene Conditions",
  "Availability of Health Care",
  "COVID Preparedness",
  "Epidemiological Factors",
  "Overall Vulnerability"
)

Theme.Vuls = Vuls.List$`Overall Vulnerability`
Theme.Vuls$Overall = percent.rank(rowSums(Theme.Vuls[,-1]), 0)
colnames(Theme.Vuls)[7] = "Overall Vulnerability"

states.shp = readOGR("IND_adm/IND_adm2.shp")
num.states = which(states.shp$NAME_1 == "Orissa")

get_legend <- function(myggplot) {
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x)
    x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}

Summary.R = data.frame(District = Districts, matrix(0, length(Districts), 1))
colnames(Summary.R)[-1] = "Last Fortnight"

for (i in 1:nrow(Summary.R))
{
  R.Summary.Full = R.Curve[[i]]$mean.R
  R.Summary.Fortnight = R.Summary.Full[(length(R.Summary.Full) - 13):length(R.Summary.Full)]
  Summary.R[i, 2] = mean(R.Summary.Fortnight)
}

Summaries = Summary.R[-nrow(Summary.R), ]

Figure.4 = list()

for (i in 2:ncol(Theme.Vuls))
{
  mydata = data.frame(NAME_2 = states.shp$NAME_2[num.states], id = states.shp$ID_2[num.states])
  mydata$NAME_2[c(2, 3, 5, 18, 23, 29)] = Theme.Vuls$District[c(3, 4, 2, 18, 23, 29)]
  mydata = mydata[order(mydata$NAME_2),]
  
  mydata = data.frame(mydata, vulnerability = Theme.Vuls[, i])
  states.shp.f = fortify(states.shp[num.states,], region = "ID_2")
  merge.shp.coef = merge(states.shp.f, mydata, by = "id", all.x = TRUE)
  final.plot = merge.shp.coef[order(merge.shp.coef$order), ]
  
  cnames = aggregate(
    cbind(long, lat) ~ NAME_2,
    data = final.plot,
    FUN = function(x)
      mean(range(x))
  )
  
  cnames = data.frame(cnames, rvalue = Summaries$`Last Fortnight`)
  cnames = cnames %>% mutate(colorscale = unlist(lapply(rvalue, Decision)))
  
  plot = ggplot() +
    geom_polygon(
      data = final.plot,
      aes(
        x = long,
        y = lat,
        group = group,
        fill = vulnerability
      ),
      color = "black",
      size = 0.25
    ) +
    coord_map() +
    scale_fill_gradient(
      name = "Vulnerability Index",
      limits = c(0, 1),
      low = "#FFFFCC",
      high = "#990000"
    ) +
    labs(title = paste0("(", LETTERS[ifelse(i == 7, 1, i)], ") ", colnames(Theme.Vuls)[i])) +
    xlab(NULL) + ylab(NULL) +
    theme(
      text = element_text(face = "bold"),
      plot.title = element_text(
        hjust = 0.5,
        face = "bold",
        size = 18
      ),
      panel.background = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      axis.text.x = element_blank(),
      axis.text.y  = element_blank(),
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_blank(),
      # plot.margin = unit(c(-3, 0, 0, 0), "cm"),
      legend.position = "bottom",
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 24)
    ) +
    geom_text(
      data = cnames,
      aes(long, lat, label = NAME_2),
      size = 3.6,
      fontface = "bold"
    ) +
    geom_point(
      data = cnames,
      aes(long, lat - 0.1, # color = colorscale,
          size = 1.2 * rvalue),
      show.legend = FALSE,
      color = "red"
    ) # +
  # scale_color_manual(values = heatmap_colors)
  
  Figure.4[[length(Figure.4) + 1]] = plot
  names(Figure.4)[length(Figure.4)] = paste0("Figure.4", LETTERS[ifelse(i == 7, 1, i)])
}

Figure.4A = Figure.4$Figure.4A

Legend.4 = get_legend(Figure.4A)

for (i in 1:length(Figure.4))
{
  Figure.4[[i]] = Figure.4[[i]] + theme(legend.position = "none")
}

Figure.4A = Figure.4$Figure.4A

Figure.4[length(Figure.4)] = NULL
Figure.4 = append(list(Legend.4, Figure.4A), Figure.4)
names(Figure.4)[1:2] = c("Legend", "Figure.4A")

blankPlot <- ggplot() + geom_blank(aes(1, 1)) + theme_nothing()

## Saving Figure 4

cairo_pdf("Figure 4.pdf",
          onefile = TRUE,
          height = 18,
          width = 27)

grid.arrange(
  Figure.4$Figure.4A,
  Figure.4$Figure.4B,
  Figure.4$Figure.4C,
  blankPlot,
  Figure.4$Legend,
  blankPlot,
  Figure.4$Figure.4D,
  Figure.4$Figure.4E,
  Figure.4$Figure.4F,
  ncol = 3,
  nrow = 3,
  widths = rep(9, 3),
  heights = c(8.4, 1.2, 8.4)
)

dev.off()

png(
  filename = "Figure 4.png",
  height = 18,
  width = 27,
  units = "in",
  type = "cairo",
  res = 144
)

grid.arrange(
  Figure.4$Figure.4A,
  Figure.4$Figure.4B,
  Figure.4$Figure.4C,
  blankPlot,
  Figure.4$Legend,
  blankPlot,
  Figure.4$Figure.4D,
  Figure.4$Figure.4E,
  Figure.4$Figure.4F,
  ncol = 3,
  nrow = 3,
  widths = rep(9, 3),
  heights = c(8.4, 1.2, 8.4)
)

dev.off()

# Figure 5

## Panels A-F

Figure.5.Data = list()

for (i in 1:length(Vuls.List))
{
  y = Summaries$`Last Fortnight`
  x = as.matrix.data.frame(Vuls.List[[i]][-1])
  
  Temp = coef(bms(
    X.data = y ~ x,
    mprior = "uniform",
    user.int = FALSE
  ))
  
  rownames(Temp) = gsub("x.", "", rownames(Temp))
  Temp = Temp[order(rownames(Temp)), ]
  
  Temp = data.frame(Temp,
                    Covariate = rownames(Temp),
                    Source = rep(names(Vuls.List)[i], nrow(Temp)))
  
  Figure.5.Data[[i]] = Temp
}

names(Figure.5.Data) = c(
  "Socioeconomic and Demographic Factors",
  "Housing and Hygiene Conditions",
  "Availability of Health Care",
  "COVID Preparedness",
  "Epidemiological Factors",
  "Overall Vulnerability"
)

Figure.5.Data = do.call("rbind", Figure.5.Data)
Figure.5.Data$Sign = ifelse(sign(Figure.5.Data$Post.Mean) == 1, "+", "-")
rownames(Figure.5.Data) = NULL

Figure.5 = list()

Colors = c("darkolivegreen3",
           "darkorange2",
           "gold1",
           "cornflowerblue",
           "salmon1",
           "black")

Panels = c("A", "B", "B", "C", "C", "A")

for (i in 1:length(Vuls.List))
{
  Figure.5[[length(Figure.5) + 1]] = Figure.5.Data[Figure.5.Data$Source == names(Vuls.List)[i], ] %>%
    ggplot(aes(x = PIP,
               y = reorder(Covariate, desc(PIP)))) + geom_col(position = "dodge", fill = Colors[i]) +
    labs(
      title = paste0("(", Panels[i], ") ", names(Vuls.List)[i]),
      x = "Posterior Inclusion Probability",
      y = "Covariates"
    ) +
    theme_minimal() +
    theme(
      text               = element_text(family = "Helvetica Neue", face = "bold"),
      plot.title         = ggtext::element_markdown(size = 15),
      plot.subtitle      = element_text(size = 14, color = "#36454f"),
      plot.caption       = ggtext::element_markdown(
        hjust = 0,
        size = 8,
        lineheight = 1.1
      ),
      axis.text.x = element_text(size = 10),
      axis.ticks.x = element_blank(),
      axis.text.y          = element_text(size = 10),
      axis.title         = element_text(size = 12),
      legend.position    = "right",
      panel.grid.major.x = element_blank(),
      panel.grid.major.y = element_blank(),
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
    ) +
    geom_label(mapping = aes(label = Sign),
               fontface = "bold",
               size = 9)
  
  names(Figure.5)[length(Figure.5)] = paste0("Figure.5", LETTERS[ifelse(i == 6, 1, i + 1)])
}

Figure.5A = Figure.5$Figure.5A

Figure.5[length(Figure.5)] = NULL
Figure.5 = append(list(Figure.5A), Figure.5)
names(Figure.5)[1] = "Figure.5A"

## Saving Figure 5

cairo_pdf("Figure 5.pdf",
          onefile = TRUE,
          height = 8,
          width = 24)

grid.arrange(
  Figure.5$Figure.5A,
  Figure.5$Figure.5D,
  Figure.5$Figure.5E,
  ncol = 3,
  nrow = 1,
  widths = rep(8, 3),
  heights = rep(8, 1)
)

dev.off()

png(
  filename = "Figure 5.png",
  height = 8,
  width = 24,
  units = "in",
  type = "cairo",
  res = 144
)

grid.arrange(
  Figure.5$Figure.5A,
  Figure.5$Figure.5D,
  Figure.5$Figure.5E,
  ncol = 3,
  nrow = 1,
  widths = rep(8, 3),
  heights = rep(8, 1)
)

dev.off()

# Supplementary Figure 1

cairo_pdf(
  "Supplementary Figure 1.pdf",
  onefile = TRUE,
  height = 8,
  width = 24
)

grid.arrange(
  Figure.5$Figure.5B,
  Figure.5$Figure.5C,
  Figure.5$Figure.5F,
  ncol = 3,
  nrow = 1,
  widths = rep(8, 3),
  heights = rep(8, 1)
)

dev.off()

png(
  filename = "Supplementary Figure 1.png",
  height = 8,
  width = 24,
  units = "in",
  type = "cairo",
  res = 144
)

grid.arrange(
  Figure.5$Figure.5B,
  Figure.5$Figure.5C,
  Figure.5$Figure.5F,
  ncol = 3,
  nrow = 1,
  widths = rep(8, 3),
  heights = rep(8, 1)
)

dev.off()

# Supplementary Figure 2

## Panels A-F

no_of_districts = length(Districts) - 1
number_of_days = rep(0, no_of_districts)
District <- unique(R.Curves.All$District)

R.Curve = list()

for (i in 1:(no_of_districts))
{
  R.Curve[[i]] <-
    R.Curves.All[which(R.Curves.All$District == Districts[i])]
}

names(R.Curve) = Districts[1:no_of_districts]

for (i in 1:no_of_districts)
{
  number_of_days[i] = length(R.Curve[[i]]$date.R)
}

min_number_of_days = 14
mean_R = time_R = list()

for (i in 1:no_of_districts)
{
  n = number_of_days[i]
  
  mean_R[[i]] <- R.Curve[[i]]$mean.R[(n - min_number_of_days + 1):n]
  time_R[[i]] <- R.Curve[[i]]$date.R[(n - min_number_of_days + 1):n]
}

opts = list(maxK = 4)
functional_pca = FPCA(mean_R, time_R, optns = opts)
pca = data.frame('pca1' = functional_pca$xiEst[, 1], 'pca2' = functional_pca$xiEst[, 2])
pca$District = names(R.Curve)

SFigure.2.Data = list()

for (i in 1:length(Vuls.List))
{
  y = pca$pca1
  x = as.matrix.data.frame(Vuls.List[[i]][-1])
  
  Temp = coef(bms(
    X.data = y ~ x,
    mprior = "uniform",
    user.int = FALSE
  ))
  
  rownames(Temp) = gsub("x.", "", rownames(Temp))
  Temp = Temp[order(rownames(Temp)), ]
  
  Temp = data.frame(Temp,
                    Covariate = rownames(Temp),
                    Source = rep(names(Vuls.List)[i], nrow(Temp)))
  
  SFigure.2.Data[[i]] = Temp
}

names(SFigure.2.Data) = c(
  "Socioeconomic and Demographic Factors",
  "Housing and Hygiene Conditions",
  "Availability of Health Care",
  "COVID Preparedness",
  "Epidemiological Factors",
  "Overall Vulnerability"
)

SFigure.2.Data = do.call("rbind", SFigure.2.Data)
SFigure.2.Data$Sign = ifelse(sign(SFigure.2.Data$Post.Mean) == 1, "+", "-")
rownames(SFigure.2.Data) = NULL

SFigure.2 = list()

Colors = c("darkolivegreen3",
           "darkorange2",
           "gold1",
           "cornflowerblue",
           "salmon1",
           "black")

for (i in 1:length(Vuls.List))
{
  SFigure.2[[length(SFigure.2) + 1]] = SFigure.2.Data[SFigure.2.Data$Source == names(Vuls.List)[i], ] %>%
    ggplot(aes(x = PIP,
               y = reorder(Covariate, desc(PIP)))) + geom_col(position = "dodge", fill = Colors[i]) +
    labs(
      title = paste0("(", LETTERS[ifelse(i == 6, 1, i + 1)], ") ", names(Vuls.List)[i]),
      x = "Posterior Inclusion Probability",
      y = "Covariates"
    ) +
    theme_minimal() +
    theme(
      text               = element_text(family = "Helvetica Neue", face = "bold"),
      plot.title         = ggtext::element_markdown(size = 15),
      plot.subtitle      = element_text(size = 14, color = "#36454f"),
      plot.caption       = ggtext::element_markdown(
        hjust = 0,
        size = 8,
        lineheight = 1.1
      ),
      axis.text.x = element_text(size = 10),
      axis.ticks.x = element_blank(),
      axis.text.y          = element_text(size = 10),
      axis.title         = element_text(size = 12),
      legend.position    = "right",
      panel.grid.major.x = element_blank(),
      panel.grid.major.y = element_blank(),
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
    ) +
    geom_label(mapping = aes(label = Sign),
               fontface = "bold",
               size = 9)
  
  names(SFigure.2)[length(SFigure.2)] = paste0("SFigure.2", LETTERS[ifelse(i == 6, 1, i + 1)])
}

SFigure.2A = SFigure.2$SFigure.2A

SFigure.2[length(SFigure.2)] = NULL
SFigure.2 = append(list(SFigure.2A), SFigure.2)
names(SFigure.2)[1] = "SFigure.2A"

## Saving Supplementary Figure 2

cairo_pdf(
  "Supplementary Figure 2.pdf",
  onefile = TRUE,
  height = 16,
  width = 24
)

grid.arrange(
  SFigure.2$SFigure.2A,
  SFigure.2$SFigure.2B,
  SFigure.2$SFigure.2C,
  SFigure.2$SFigure.2D,
  SFigure.2$SFigure.2E,
  SFigure.2$SFigure.2F,
  ncol = 3,
  nrow = 2,
  widths = rep(8, 3),
  heights = rep(8, 2)
)

dev.off()

png(
  filename = "Supplementary Figure 2.png",
  height = 16,
  width = 24,
  units = "in",
  type = "cairo",
  res = 144
)

grid.arrange(
  SFigure.2$SFigure.2A,
  SFigure.2$SFigure.2B,
  SFigure.2$SFigure.2C,
  SFigure.2$SFigure.2D,
  SFigure.2$SFigure.2E,
  SFigure.2$SFigure.2F,
  ncol = 3,
  nrow = 2,
  widths = rep(8, 3),
  heights = rep(8, 2)
)

dev.off()

# Supplementary Figure 3

SFigure.3A = ggdensity(Summaries$`Last Fortnight`,
                       title = paste0("(A) Density Plot for Instantaneous R")) +
  theme_classic() +
  theme(text = element_text(face = "bold")) + labs(x = "Instantaneous R",
                                                   y = "Density")

SFigure.3B = ggqqplot(Summaries$`Last Fortnight`,
                      title = paste0("(B) QQ Plot for Instantaneous R")) +
  theme_classic() +
  theme(text = element_text(face = "bold")) + labs(x = "Normal (Theoretical) Quantiles",
                                                   y = "Sample (Instantaneous R) Quantiles")

cairo_pdf("Supplementary Figure 3.pdf",
          height = 8,
          width = 16)

do.call("grid.arrange", c(list(SFigure.3A, SFigure.3B), ncol = 2))

dev.off()

png(
  filename = "Supplementary Figure 3.png",
  height = 8,
  width = 16,
  units = "in",
  type = "cairo",
  res = 144
)

do.call("grid.arrange", c(list(SFigure.3A, SFigure.3B), ncol = 2))

dev.off()

# Save environment

save.image("All Final Figures.rda")