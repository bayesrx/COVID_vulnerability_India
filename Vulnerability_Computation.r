library(ggplot2)
library(maptools)
library(rgeos)
library(Cairo)
library(ggmap)
library(scales)
library(RColorBrewer)
library(mapproj)
library(viridis)
library(hrbrthemes)
library(reshape2)

####################################################### VI calculator fn. ##############################################################

percent.rank <- function(x, or)
{
  uni = sort(x, decreasing = ifelse(or ==  0, FALSE, TRUE))
  r = sapply(x, function(x) {
    which(uni == x)[1]
  })
  return((r - 1) / (length(x) - 1))
}

########################################################### VI calculation #############################################################

theme_dat = read.csv("Data/Vulnerability_Data/Vulnerability_Covariates.csv",
                     header = T)

sort.ord = c(0, rep(1, (3 + 3 + 3 + 5)), rep(0, 10))


per.ranklist = lapply(1:25, function(x) {
  percent.rank(theme_dat[, (x + 1)], sort.ord[x])
})
rank.mat = matrix(unlist(per.ranklist), ncol = 25)

cor_covariate = array(dim = c(25, 25))
for (i in 1:25)
{
  for (j in 1:25)
  {
    cor_covariate[i, j] = cor(rank.mat[, i], rank.mat[, j])
  }
}

theme_wise_rank = cbind(
  rowSums(rank.mat[, 1:4]),
  rowSums(rank.mat[, 5:7]),
  rowSums(rank.mat[, 8:10]),
  rowSums(rank.mat[, 11:15]),
  rowSums(rank.mat[, 16:25])
)

sort.ord.theme = rep(0, 5)

theme.per.rank = lapply(1:5, function(x) {
  percent.rank(theme_wise_rank[, x], sort.ord.theme[x])
})
rank.mat.theme = matrix(unlist(theme.per.rank), ncol = 5)

cor_theme = array(dim = c(5, 5))
for (i in 1:5)
{
  for (j in 1:5)
  {
    cor_theme[i, j] = cor(rank.mat.theme[, i], rank.mat.theme[, j])
  }
}

cov_names = c(
  "Population of 2019",
  "Literacy Rate( for future purpose) Females",
  "Work Participation Rate Total",
  "NDDP At Current Price(Rs.)",
  "Household with improved Drinking Water Sources",
  "Household using improved Sanitation facility (swasthya bharat)",
  "Household using clean fuel for cooking( from ujwala_",
  "PHC's+CHC's per 10k	",
  "SUB DIVISIONAL hospital per 10k",
  "General No. of beds per 10k",
  "Total Beds Capacity per 10k",
  "Total ICU Beds per 10K",
  "Temporary medical camps Rural",
  "Temporary medical camps Urban",
  "covid hopitaltesting centre",
  "% Total HIV Positive to Total Tested ( Male + Female)",
  "% Plasmodium Vivax test positive to Total Blood Smears Examined",
  "% Plasmodium Falciparum test positive to Total Blood Smears Examined",
  "% Deaths due to Pneumonia to Total Reported Infant Deaths",
  "% Resident of the household TB",
  "Hypertension (%)",
  "Cervix (%)",
  " Breast (%)",
  "	Oral cavity (%)",
  "Total who are overweight or obese"
)

theme_names = c(
  "Socioeconomic demographic factors",
  "Housing and hygiene condition",
  "Availability of health care",
  "Preparedness of COVID",
  "Epidemiological factor"
)

############################################### correlation heatmap ####################################################################

rownames(cor_covariate) = cov_names
colnames(cor_covariate) = cov_names
cor_covariate[lower.tri(cor_covariate)] = NA
# cor_covariate[which(abs(cor_covariate) < 0.75)] = NA
cor_covariate = melt(cor_covariate, na.rm = TRUE)

rownames(cor_theme) = theme_names
colnames(cor_theme) = theme_names
cor_theme[lower.tri(cor_theme)] = NA
# cor_theme[which(abs(cor_theme) < 0.75)] = NA
cor_theme = melt(cor_theme, na.rm = TRUE)

l = list(cor_covariate, cor_theme)
for (j in 1:2)
{
  p = ggplot(l[[j]], aes(Var2, Var1, fill = value)) +
    geom_tile() +
    scale_fill_gradient2(
      name = "Correlation value",
      low = "blue",
      mid = "#FFFF66",
      high = "red",
      limit = c(-1, 1)
    )  +
    theme_minimal() + theme(
      axis.text.x = element_text(
        angle = 60,
        vjust = 1,
        size = 12,
        hjust = 1
      ),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      plot.title = element_text(hjust = 0.5)
    ) +
    labs(title = "CORRELATION HEATMAP")
  print(p)
  # ggsave(p, file = paste0("Correlation heatmap_",j,"_cutoff_0.75",".png"), width = 20, height = 10, type = "cairo-png")
}

pooled = cbind(rank.mat, rank.mat.theme)
rownames(pooled) = theme_dat[, 1]
colnames(pooled) = c(cov_names, theme_names)

pooled = cbind(pooled, overall_vulnerability = percent.rank(rowSums(rank.mat.theme), 0))
write.csv(pooled,
          "Data/Vulnerability_Data/Vulnerability_Computed.csv")

######################################################### heatmap construction ########################################################

A = rank.mat.theme
rownames(A) = theme_dat[, 1]
colnames(A) = theme_names
heat.rankA = A
logit.rankA = A
eps = 10 ^ (-6)
logit.rankA[which(logit.rankA == 0)] = eps
logit.rankA[which(logit.rankA == 1)] = 1 - eps
logit.rankA = log(logit.rankA) - log(1 - logit.rankA)
heat.rankA = melt(heat.rankA)
logit.rankA = melt(logit.rankA)
lA = list(heat.rankA, logit.rankA)
vA = c("(raw)", "(logit transform)")
for (j in 1:2)
{
  p = ggplot(lA[[j]], aes(Var2, Var1, fill = value)) +
    geom_tile() +
    scale_fill_gradient(name = "Index value", low = "#FFFFCC", high = "#990000")  +
    theme(
      axis.text.x = element_text(
        angle = 60,
        vjust = 1,
        size = 12,
        hjust = 1
      ),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    ) +
    labs(title = paste0("Heatmap of theme vulnerability over districts ", vA[j]))
  print(p)
  # ggsave(p, file = paste0("theme_",j,".png"), width = 20, height = 10, type = "cairo-png")
}

B = rank.mat
rownames(B) = theme_dat[, 1]
colnames(B) = cov_names
heat.rank = B
logit.rank = B
eps = 10 ^ (-6)
logit.rank[which(logit.rank == 0)] = eps
logit.rank[which(logit.rank == 1)] = 1 - eps
logit.rank = log(logit.rank) - log(1 - logit.rank)
heat.rank = melt(heat.rank)
logit.rank = melt(logit.rank)
l = list(heat.rank, logit.rank)
v = c("(raw)", "(logit transform)")
for (j in 1:2)
{
  p = ggplot(l[[j]], aes(Var2, Var1, fill = value)) +
    geom_tile() +
    scale_fill_gradient(name = "Index value", low = "#FFFFCC", high = "#990000")  +
    theme(
      axis.text.x = element_text(
        angle = 60,
        vjust = 1,
        size = 12,
        hjust = 1
      ),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    ) +
    labs(title = paste0("Heatmap of Vulnerability indices over districts ", v[j]))
  print(p)
  # ggsave(p, file = paste0("theme_",j,".png"), width = 20, height = 10, type = "cairo-png")
}


######################################### Plotting the spatial maps ##################################################################

states.shp = readShapePoly(file.choose("Data/Geographical_Data/IND_adm2.shp"))
num.states = which(states.shp$NAME_1 == "Orissa")

for (i in 1:25)
{
  mydata = data.frame(
    NAME_2 = states.shp$NAME_2[num.states],
    id = states.shp$ID_2[num.states],
    vulnerability = rank.mat[, i]
  )
  states.shp.f = fortify(states.shp[num.states, ], region = "ID_2")
  merge.shp.coef = merge(states.shp.f, mydata, by = "id", all.x = TRUE)
  final.plot = merge.shp.coef[order(merge.shp.coef$order),]
  cnames = aggregate(
    cbind(long, lat) ~ NAME_2,
    data = final.plot,
    FUN = function(x)
      mean(range(x))
  )
  plot = ggplot() +
    geom_polygon(
      data = final.plot,
      aes(
        x = long,
        y = lat,
        group = group,
        fill = vulnerability
      ),
      color = "black",
      size = 0.25
    ) +
    coord_map() +
    scale_fill_gradient(
      name = "Index value",
      limits = c(0, 1),
      low = "#FFFFCC",
      high = "#990000"
    ) +
    labs(title = paste0("Vulnerability based on ", cov_names[i])) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold"),
      panel.background = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      axis.text.x = element_blank(),
      axis.text.y  = element_blank(),
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_blank()
    ) +
    geom_text(
      data = cnames,
      aes(long, lat, label = NAME_2),
      size = 2.5,
      fontface = "bold"
    )
  print(plot)
  # ggsave(plot, file = paste0("indicator_",i,".png"), width = 8, height = 4.5, type = "cairo-png")
}

for (i in 1:5)
{
  mydata = data.frame(
    NAME_2 = states.shp$NAME_2[num.states],
    id = states.shp$ID_2[num.states],
    vulnerability = rank.mat.theme[, i]
  )
  states.shp.f = fortify(states.shp[num.states, ], region = "ID_2")
  merge.shp.coef = merge(states.shp.f, mydata, by = "id", all.x = TRUE)
  final.plot = merge.shp.coef[order(merge.shp.coef$order),]
  cnames = aggregate(
    cbind(long, lat) ~ NAME_2,
    data = final.plot,
    FUN = function(x)
      mean(range(x))
  )
  plot = ggplot() +
    geom_polygon(
      data = final.plot,
      aes(
        x = long,
        y = lat,
        group = group,
        fill = vulnerability
      ),
      color = "black",
      size = 0.25
    ) +
    coord_map() +
    scale_fill_gradient(
      name = "Index value",
      limits = c(0, 1),
      low = "#FFFFCC",
      high = "#990000"
    ) +
    labs(title = paste0("Vulnerability based on ", theme_names[i])) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold"),
      panel.background = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      axis.text.x = element_blank(),
      axis.text.y  = element_blank(),
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_blank()
    ) +
    geom_text(
      data = cnames,
      aes(long, lat, label = NAME_2),
      size = 2.5,
      fontface = "bold"
    )
  print(plot)
  # ggsave(plot, file = paste0("theme_",i,".png"), width = 8, height = 4.5, type = "cairo-png")
}

overall_vul = rowSums(rank.mat.theme)
overall.rank = percent.rank(overall_vul, 0)

mydata = data.frame(
  NAME_2 = states.shp$NAME_2[num.states],
  id = states.shp$ID_2[num.states],
  vulnerability = overall.rank
)
states.shp.f = fortify(states.shp[num.states, ], region = "ID_2")
merge.shp.coef = merge(states.shp.f, mydata, by = "id", all.x = TRUE)
final.plot = merge.shp.coef[order(merge.shp.coef$order),]
cnames = aggregate(
  cbind(long, lat) ~ NAME_2,
  data = final.plot,
  FUN = function(x)
    mean(range(x))
)
plot = ggplot() +
  geom_polygon(
    data = final.plot,
    aes(
      x = long,
      y = lat,
      group = group,
      fill = vulnerability
    ),
    color = "black",
    size = 0.25
  ) +
  coord_map() +
  scale_fill_gradient(
    name = "Index value",
    limits = c(0, 1),
    low = "#FFFFCC",
    high = "#990000"
  ) +
  labs(title = "Overall Vulnerability") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    panel.background = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  ) +
  geom_text(
    data = cnames,
    aes(long, lat, label = NAME_2),
    size = 2.5,
    fontface = "bold"
  )
print(plot)
# ggsave(plot, file = paste0("overall_vul.png"), width = 8, height = 4.5, type = "cairo-png")



###################################### clustering ############################################

library(tidyverse)  # data manipulation
library(cluster)    # clustering algorithms
library(factoextra) # clustering visualization
library(dendextend) # for comparing two dendrograms

rownames(rank.mat) = theme_dat[, 1]
rownames(rank.mat.theme) = theme_dat[, 1]

mean_lat_long = array(dim = c(30, 2)) # district centres

for (i in 1:30)
{
  la = mean(final.plot$lat[which(final.plot$id == (361 + i))])
  lo = mean(final.plot$long[which(final.plot$id == (361 + i))])
  mean_lat_long[i, ] = c(la, lo)
}

clus_dat = cbind(rank.mat, mean_lat_long)
clus_dat_theme = cbind(rank.mat.theme, mean_lat_long)


A = rank.mat.theme # rank.mat.theme # rank.mat # clus_dat # clus_dat_theme

########################################################################################
########################################################################################

# distance metric calculation ###################################################

# Dissimilarity matrix
d = dist(A, method = "euclidean") # "euclidean""minkowski" "maximum" "manhattan" "canberra" "binary"

# hierarchichal clustering AGNES (bottom to top) ################################

hc1 = hclust(d, method = "ward.D2") # "average" "single" "complete" "ward.D2"

plot(hc1,
     cex = 0.8,
     hang = -1,
     main = "Dendrogram AGNES")

rect.hclust(hc1, k = 4, border = 2:5)

# hierarchichal clustering DIANA (top to bottom) ################################

# compute divisive hierarchical clustering
hc4 = diana(d)

# Divise coefficient hc4$dc = amount of clustering structure found

print(hc4$dc)

pltree(hc4,
       cex = 0.8,
       hang = -1,
       main = "Dendrogram DIANA")

# subset diagram ################################################################

sub_grp = cutree(hc4, k = 4)

fviz_cluster(list(data = A, cluster = sub_grp))

### Gap statistic #################################################################

gap_stat = clusGap(A, FUN = hcut, K.max = 10, B = 100)
print(fviz_gap_stat(gap_stat))

########################################################################################
########################################################################################

B = scale(A)
pca = stats::prcomp(B, scale = FALSE, center = FALSE)

eigen_values = pca$sdev ^ 2
print(eigen_values)

e_vec = pca$rotation
print(e_vec)

dim1 = 100 * (eigen_values[1] / sum(eigen_values))
dim2 = 100 * (eigen_values[2] / sum(eigen_values))

print(paste0("dim1 = ", round(dim1, 1), "%"))
print(paste0("dim2 = ", round(dim2, 1), "%"))

coords = B %*% e_vec[, 1:2]

ggplot(data.frame(coords),
       aes(
         x = coords[, 1],
         y = coords[, 2],
         color = as.factor(sub_grp)
       )) + geom_point()
# these are the points plotted in the cluster plot (same using fviz_cluster)

################################# working of fviz_cluster function ######################
